
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ogusa.txfunc &#8212; OG-USA 0.6.2 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ogusa.txfunc</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">This script reads in data generated from the OSPC Tax Calculator and</span>
<span class="sd">the 2009 IRS PUF. It then estimates tax functions tau_{s,t}(x,y), where</span>
<span class="sd">tau_{s,t} is the effective tax rate, marginal tax rate on labor income,</span>
<span class="sd">or the marginal tax rate on capital income, for a given age (s) in a</span>
<span class="sd">particular year (t). x is total labor income, and y is total capital</span>
<span class="sd">income.</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c1"># Import packages</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">delayed</span><span class="p">,</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">dask.multiprocessing</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">ogusa</span> <span class="kn">import</span> <span class="n">get_micro_data</span>
<span class="kn">import</span> <span class="nn">ogusa.parameter_plots</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">from</span> <span class="nn">ogusa.constants</span> <span class="kn">import</span> <span class="n">DEFAULT_START_YEAR</span><span class="p">,</span> <span class="n">SHOW_RUNTIME</span>
<span class="kn">import</span> <span class="nn">warnings</span>


<span class="k">if</span> <span class="ow">not</span> <span class="n">SHOW_RUNTIME</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

<span class="n">CUR_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">MIN_OBS</span> <span class="o">=</span> <span class="mi">240</span>  <span class="c1"># 240 is 8 parameters to estimate X 30 obs per parameter</span>
<span class="n">MAX_ETR</span> <span class="o">=</span> <span class="mf">0.65</span>
<span class="n">MAX_MTR</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">MIN_INCOME</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MIN_INC_GRAPH</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MAX_INC_GRAPH</span> <span class="o">=</span> <span class="mi">500000</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">Define Functions</span>
<span class="sd">------------------------------------------------------------------------</span>
<span class="sd">&#39;&#39;&#39;</span>


<div class="viewcode-block" id="get_tax_rates"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.get_tax_rates">[docs]</a><span class="k">def</span> <span class="nf">get_tax_rates</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">,</span>
                  <span class="n">for_estimation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Generates tax rates given income data and the parameters of the tax</span>
<span class="sd">    functions.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (tuple): parameters of the tax function, varies by</span>
<span class="sd">            tax_func_type</span>
<span class="sd">        X (array_like): labor income data</span>
<span class="sd">        Y (array_like): capital income data</span>
<span class="sd">        wgts (array_like): weights for data observations</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>
<span class="sd">        for_estimation (bool): whether the results are used in</span>
<span class="sd">            estimation, if True, then tax rates are computed as</span>
<span class="sd">            deviations from the mean</span>

<span class="sd">    Returns:</span>
<span class="sd">        txrates (array_like): model tax rates for each observation</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">income</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s1">&#39;GS&#39;</span><span class="p">:</span>
        <span class="n">phi0</span><span class="p">,</span> <span class="n">phi1</span><span class="p">,</span> <span class="n">phi2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s1">&#39;etr&#39;</span><span class="p">:</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">phi0</span> <span class="o">*</span> <span class="p">(</span><span class="n">income</span> <span class="o">-</span> <span class="p">((</span><span class="n">income</span> <span class="o">**</span> <span class="o">-</span><span class="n">phi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span> <span class="o">**</span>
                         <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">phi1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">income</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># marginal tax rate function</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi0</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">income</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">phi1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
                                  <span class="p">((</span><span class="n">income</span> <span class="o">**</span> <span class="o">-</span><span class="n">phi1</span><span class="p">)</span> <span class="o">+</span> <span class="n">phi2</span><span class="p">)</span>
                                  <span class="o">**</span> <span class="p">((</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi1</span><span class="p">)</span> <span class="o">/</span> <span class="n">phi1</span><span class="p">))))</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s1">&#39;DEP&#39;</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">Etil</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span>
        <span class="n">Ftil</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="n">D</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">X2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Xbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Y2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Ybar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">X2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">-</span> <span class="n">X2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">X2bar</span>
            <span class="n">Xtil</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">Xbar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Xbar</span>
            <span class="n">Y2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">-</span> <span class="n">Y2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Y2bar</span>
            <span class="n">Ytil</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Ybar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Ybar</span>
            <span class="n">tau_x</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Xtil</span> <span class="o">+</span> <span class="n">Etil</span><span class="p">)</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Xtil</span> <span class="o">+</span> <span class="n">Etil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span>
            <span class="n">tau_y</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2til</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Ytil</span> <span class="o">+</span> <span class="n">Ftil</span><span class="p">)</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2til</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Ytil</span> <span class="o">+</span> <span class="n">Ftil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span> <span class="o">*</span>
                       <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">)))</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tau_x</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span><span class="p">)</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">X2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">X</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">min_x</span><span class="p">)</span>
            <span class="n">tau_y</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span><span class="p">)</span> <span class="o">/</span>
                      <span class="p">(</span><span class="n">C</span> <span class="o">*</span> <span class="n">Y2</span> <span class="o">+</span> <span class="n">D</span> <span class="o">*</span> <span class="n">Y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">min_y</span><span class="p">)</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="p">(((</span><span class="n">tau_x</span> <span class="o">+</span> <span class="n">shift_x</span><span class="p">)</span> <span class="o">**</span> <span class="n">share</span><span class="p">)</span> <span class="o">*</span>
                       <span class="p">((</span><span class="n">tau_y</span> <span class="o">+</span> <span class="n">shift_y</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">share</span><span class="p">)))</span> <span class="o">+</span> <span class="n">shift</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s1">&#39;DEP_totalinc&#39;</span><span class="p">:</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">max_income</span><span class="p">,</span> <span class="n">min_income</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">shift_income</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">))</span>
        <span class="n">Etil</span> <span class="o">=</span> <span class="n">A</span> <span class="o">+</span> <span class="n">B</span>
        <span class="n">income2</span> <span class="o">=</span> <span class="n">income</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">for_estimation</span><span class="p">:</span>
            <span class="n">income2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">Ibar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">income2til</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">-</span> <span class="n">income2bar</span><span class="p">)</span> <span class="o">/</span> <span class="n">income2bar</span>
            <span class="n">Itil</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">-</span> <span class="n">Ibar</span><span class="p">)</span> <span class="o">/</span> <span class="n">Ibar</span>
            <span class="n">tau_income</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span> <span class="o">*</span>
                           <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Itil</span> <span class="o">+</span> <span class="n">Etil</span><span class="p">)</span> <span class="o">/</span>
                           <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2til</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">Itil</span> <span class="o">+</span> <span class="n">Etil</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span>
                          <span class="n">min_income</span><span class="p">)</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">tau_income</span> <span class="o">+</span> <span class="n">shift_income</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tau_income</span> <span class="o">=</span> <span class="p">(((</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">)</span> <span class="o">*</span>
                           <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span><span class="p">)</span> <span class="o">/</span>
                           <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">income2</span> <span class="o">+</span> <span class="n">B</span> <span class="o">*</span> <span class="n">income</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">min_income</span><span class="p">)</span>
            <span class="n">txrates</span> <span class="o">=</span> <span class="n">tau_income</span> <span class="o">+</span> <span class="n">shift_income</span> <span class="o">+</span> <span class="n">shift</span>

    <span class="k">return</span> <span class="n">txrates</span></div>


<div class="viewcode-block" id="wsumsq"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.wsumsq">[docs]</a><span class="k">def</span> <span class="nf">wsumsq</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function generates the weighted sum of squared deviations of</span>
<span class="sd">    predicted values of tax rates (ETR, MTRx, or MTRy) from the tax</span>
<span class="sd">    rates from the data for the Cobb-Douglas functional form of the tax</span>
<span class="sd">    function.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (tuple): tax function parameter values</span>
<span class="sd">        args (tuple): contains (fixed_tax_func_params, X, Y, txrates,</span>
<span class="sd">            wgts, tax_func_type, rate_type)</span>
<span class="sd">        fixed_tax_func_params (tuple): value of parameters of tax</span>
<span class="sd">            functions that are not estimated</span>
<span class="sd">        X (array_like): labor income data</span>
<span class="sd">        Y (array_like): capital income data</span>
<span class="sd">        txrates (array_like): tax rates data</span>
<span class="sd">        wgts (array_like): weights for data observations</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>

<span class="sd">    Returns:</span>
<span class="sd">        wssqdev (scalar): weighted sum of squared deviations, &gt;0</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">fixed_tax_func_params</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span>
     <span class="n">rate_type</span><span class="p">)</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">params_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">fixed_tax_func_params</span><span class="p">)</span>
    <span class="n">txrates_est</span> <span class="o">=</span> <span class="n">get_tax_rates</span><span class="p">(</span>
        <span class="n">params_all</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">txrates_est</span> <span class="o">-</span> <span class="n">txrates</span>
    <span class="n">wssqdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">wgts</span> <span class="o">*</span> <span class="p">(</span><span class="n">errors</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">wssqdev</span></div>


<div class="viewcode-block" id="find_outliers"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.find_outliers">[docs]</a><span class="k">def</span> <span class="nf">find_outliers</span><span class="p">(</span><span class="n">sse_mat</span><span class="p">,</span> <span class="n">age_vec</span><span class="p">,</span> <span class="n">se_mult</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span>
                  <span class="n">graph</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function takes a matrix of sum of squared errors (SSE) from</span>
<span class="sd">    tax function estimations for each age (s) in each year of the budget</span>
<span class="sd">    window (t) and marks estimations that have outlier SSE.</span>

<span class="sd">    Args:</span>
<span class="sd">        sse_mat (Numpy array): SSE for each estimated tax function,</span>
<span class="sd">            size is SxBW</span>
<span class="sd">        age_vec (numpy array): vector of ages, length S</span>
<span class="sd">        se_mult (scalar): multiple of standard deviations before</span>
<span class="sd">            consider estimate an outlier</span>
<span class="sd">        start_year (int): first year of budget window</span>
<span class="sd">        varstr (str): name of tax function being evaluated</span>
<span class="sd">        graph (bool): whether to output graphs</span>

<span class="sd">    Returns:</span>
<span class="sd">        sse_big_mat (Numpy array): indicators of weither tax function</span>
<span class="sd">            is outlier, size is SxBW</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Mark outliers from estimated MTRx functions</span>
    <span class="n">thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">sse_mat</span><span class="p">[</span><span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span>
              <span class="n">se_mult</span> <span class="o">*</span> <span class="n">sse_mat</span><span class="p">[</span><span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
    <span class="n">sse_big_mat</span> <span class="o">=</span> <span class="n">sse_mat</span> <span class="o">&gt;</span> <span class="n">thresh</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">varstr</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
          <span class="s2">&quot; observations tagged as outliers.&quot;</span><span class="p">)</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUR_PATH</span><span class="p">,</span> <span class="s1">&#39;OUTPUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TaxFunctions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span>
                           <span class="n">output_dir</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Mark the outliers from the first sweep above. Then mark the</span>
        <span class="c1"># new outliers in a second sweep</span>
        <span class="n">sse_mat_new</span> <span class="o">=</span> <span class="n">sse_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_big_mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">thresh2</span> <span class="o">=</span> <span class="p">(</span><span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">se_mult</span> <span class="o">*</span>
                   <span class="n">sse_mat_new</span><span class="p">[</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="n">sse_big_mat</span> <span class="o">+=</span> <span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="n">thresh2</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">varstr</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="s2">&quot;After second round, &quot;</span><span class="p">,</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
              <span class="s2">&quot; observations tagged as outliers (cumulative).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat_new</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">varstr</span><span class="p">,</span>
                               <span class="n">output_dir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sse_mat_new</span> <span class="o">&gt;</span> <span class="n">thresh2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Mark the outliers from the second sweep above</span>
            <span class="n">sse_mat_new2</span> <span class="o">=</span> <span class="n">sse_mat_new</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">sse_mat_new2</span><span class="p">[</span><span class="n">sse_big_mat</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_sse_plot</span><span class="p">(</span><span class="n">age_vec</span><span class="p">,</span> <span class="n">sse_mat_new2</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span>
                                   <span class="n">varstr</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sse_big_mat</span></div>


<div class="viewcode-block" id="replace_outliers"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.replace_outliers">[docs]</a><span class="k">def</span> <span class="nf">replace_outliers</span><span class="p">(</span><span class="n">param_arr</span><span class="p">,</span> <span class="n">sse_big_mat</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function replaces outlier estimated tax function parameters</span>
<span class="sd">    with linearly interpolated tax function tax function parameters</span>

<span class="sd">    Args:</span>
<span class="sd">        param_arr (Numpy array): estimated tax function parameters,</span>
<span class="sd">            size is SxBWx#tax params</span>
<span class="sd">        sse_big_mat (Numpy array): indicators of weither tax function</span>
<span class="sd">            is outlier, size is SxBW</span>

<span class="sd">    Returns:</span>
<span class="sd">        param_arr_adj (Numpy array): estimated and interpolated tax</span>
<span class="sd">            function parameters, size SxBWx#tax params</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">numparams</span> <span class="o">=</span> <span class="n">param_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">age_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">param_arr_adj</span> <span class="o">=</span> <span class="n">param_arr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">age_ind</span><span class="p">:</span>
            <span class="c1"># Smooth out ETR tax function outliers</span>
            <span class="k">if</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># For all outlier observations, increase the big_cnt by</span>
                <span class="c1"># 1 and set the param_arr_adj equal to nan</span>
                <span class="n">big_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="ow">and</span> <span class="n">big_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">big_cnt</span><span class="p">:</span>
                <span class="c1"># When the current function is not an outlier but the last</span>
                <span class="c1"># one was and this string of outliers is at the beginning</span>
                <span class="c1"># ages, set the outliers equal to this period&#39;s tax function</span>
                <span class="n">reshaped</span> <span class="o">=</span> <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
                <span class="n">param_arr_adj</span><span class="p">[:</span><span class="n">big_cnt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">reshaped</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="ow">and</span> <span class="n">big_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">big_cnt</span><span class="p">:</span>
                <span class="c1"># When the current function is not an outlier but the last</span>
                <span class="c1"># one was and this string of outliers is in the interior of</span>
                <span class="c1"># ages, set the outliers equal to a linear interpolation</span>
                <span class="c1"># between the two bounding non-outlier functions</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span>
                        <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:])</span>
                <span class="n">slopevec</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">/</span> <span class="p">(</span><span class="n">big_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">slopevec</span> <span class="o">=</span> <span class="n">slopevec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                <span class="n">tiled_slopevec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">slopevec</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">interceptvec</span> <span class="o">=</span> \
                    <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                        <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                <span class="n">tiled_intvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">interceptvec</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">reshaped_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">big_cnt</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">tiled_reshape_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">reshaped_arange</span><span class="p">,</span>
                                               <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>

                <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">big_cnt</span><span class="p">:</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">tiled_intvec</span> <span class="o">+</span> <span class="n">tiled_slopevec</span> <span class="o">*</span> <span class="n">tiled_reshape_arange</span>
                <span class="p">)</span>

                <span class="n">big_cnt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">sse_big_mat</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">sse_big_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># When the last ages are outliers, set the parameters equal</span>
                <span class="c1"># to the most recent non-outlier tax function</span>
                <span class="n">big_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">reshaped</span> <span class="o">=</span> <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)</span>
                <span class="n">param_arr_adj</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">big_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">reshaped</span><span class="p">,</span> <span class="p">(</span><span class="n">big_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">param_arr_adj</span></div>


<div class="viewcode-block" id="txfunc_est"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.txfunc_est">[docs]</a><span class="k">def</span> <span class="nf">txfunc_est</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">numparams</span><span class="p">,</span>
               <span class="n">output_dir</span><span class="p">,</span> <span class="n">graph</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function uses tax tax rate and income data for individuals of a</span>
<span class="sd">    particular age (s) and a particular year (t) to estimate the</span>
<span class="sd">    parameters of a Cobb-Douglas aggregation function of two ratios of</span>
<span class="sd">    polynomials in labor income and capital income, respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        df (Pandas DataFrame): 11 variables with N observations of tax</span>
<span class="sd">            rates</span>
<span class="sd">        s (int): age of individual, &gt;= 21</span>
<span class="sd">        t (int): year of analysis, &gt;= 2016</span>
<span class="sd">        rate_type (str): type of tax rate: mtrx, mtry, etr</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        numparams (int): number of parameters in the tax functions</span>
<span class="sd">        output_dir (str): output directory for saving plot files</span>
<span class="sd">        graph (bool): whether to plot the estimated functions compared</span>
<span class="sd">            to the data</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tax function estimation output:</span>

<span class="sd">            * params (Numpy array): vector of estimated parameters</span>
<span class="sd">            * wsse (scalar): weighted sum of squared deviations from</span>
<span class="sd">                minimization</span>
<span class="sd">            * obs (int): number of obervations in the data, &gt; 600</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span>
    <span class="n">wgts</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">Y2</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">X2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Xbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Y2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">Ybar</span> <span class="o">=</span> <span class="p">(</span><span class="n">Y</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">income</span> <span class="o">=</span> <span class="n">X</span> <span class="o">+</span> <span class="n">Y</span>
    <span class="n">income2</span> <span class="o">=</span> <span class="n">income</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">Ibar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">income2bar</span> <span class="o">=</span> <span class="p">(</span><span class="n">income2</span> <span class="o">*</span> <span class="n">wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">wgts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s1">&#39;etr&#39;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s1">&#39;mtrx&#39;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">rate_type</span> <span class="o">==</span> <span class="s1">&#39;mtry&#39;</span><span class="p">:</span>
        <span class="n">txrates</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]</span>
    <span class="n">x_10pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">y_10pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="n">x_20pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">y_20pctl</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="o">.</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_10pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">min_y</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_10pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s1">&#39;DEP&#39;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate DeBacker, Evans, Phillips (2018) ratio of polynomial</span>
        <span class="c1"># tax functions.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="n">Atil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Btil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Ctil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Dtil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">max_x_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">max_y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">share_init</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil_init</span><span class="p">,</span> <span class="n">Btil_init</span><span class="p">,</span> <span class="n">Ctil_init</span><span class="p">,</span>
                                <span class="n">Dtil_init</span><span class="p">,</span> <span class="n">max_x_init</span><span class="p">,</span> <span class="n">max_y_init</span><span class="p">,</span>
                                <span class="n">share_init</span><span class="p">])</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">shift</span><span class="p">]),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span>
                   <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">)</span>
        <span class="n">lb_max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">lb_max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">lb_max_x</span><span class="p">,</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">),</span>
                <span class="p">(</span><span class="n">lb_max_y</span><span class="p">,</span> <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">wsumsq</span><span class="p">,</span> <span class="n">params_init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                                  <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                                  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
        <span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">Ctil</span><span class="p">,</span> <span class="n">Dtil</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="c1"># message = (&quot;(max_x, min_x)=(&quot; + str(max_x) + &quot;, &quot; + str(min_x) +</span>
        <span class="c1">#     &quot;), (max_y, min_y)=(&quot; + str(max_y) + &quot;, &quot; + str(min_y) + &quot;)&quot;)</span>
        <span class="c1"># print(message)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shift_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_x</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span>
        <span class="n">shift_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">Ctil</span><span class="p">,</span> <span class="n">Dtil</span><span class="p">])</span> <span class="o">/</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X2bar</span><span class="p">,</span> <span class="n">Xbar</span><span class="p">,</span> <span class="n">Y2bar</span><span class="p">,</span> <span class="n">Ybar</span><span class="p">]))</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">shift_x</span><span class="p">,</span>
                               <span class="n">shift_y</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">share</span><span class="p">])</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span>
                                  <span class="n">shift</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s1">&#39;DEP_totalinc&#39;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate DeBacker, Evans, Phillips (2018) ratio of polynomial</span>
        <span class="c1"># tax functions as a function of total income.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="n">Atil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Btil_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">max_x_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">max_y_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
            <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="n">max_income_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_x_init</span><span class="p">,</span> <span class="n">max_y_init</span><span class="p">)</span>
        <span class="n">min_income</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">txrates</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x_20pctl</span><span class="p">)</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">y_20pctl</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">share_init</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil_init</span><span class="p">,</span> <span class="n">Btil_init</span><span class="p">,</span> <span class="n">max_income_init</span><span class="p">])</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">min_income</span><span class="p">,</span> <span class="n">shift</span><span class="p">]),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span>
                   <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">)</span>
        <span class="n">lb_max_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="n">lb_max_income</span><span class="p">,</span>
                                               <span class="n">MAX_ETR</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">))</span>
        <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">wsumsq</span><span class="p">,</span> <span class="n">params_init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                                  <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                                  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
        <span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="n">max_income</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">shift_income</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="o">-</span><span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span>
                        <span class="p">(</span><span class="n">max_income</span> <span class="o">-</span> <span class="n">min_income</span><span class="p">))</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Atil</span><span class="p">,</span> <span class="n">Btil</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span> <span class="o">/</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">income2bar</span><span class="p">,</span> <span class="n">Ibar</span><span class="p">,</span> <span class="n">Y2bar</span><span class="p">,</span> <span class="n">Ybar</span><span class="p">]))</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_income</span><span class="p">,</span> <span class="n">min_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                               <span class="n">shift_income</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">share</span><span class="p">,</span> <span class="n">min_x</span><span class="p">,</span>
                                             <span class="n">min_y</span><span class="p">,</span> <span class="n">shift</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;GS&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># Estimate Gouveia-Strauss parameters via least squares.</span>
        <span class="c1"># Need to use a different functional form than for DEP function.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="n">phi0_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">phi1_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">phi2_init</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">params_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi0_init</span><span class="p">,</span> <span class="n">phi1_init</span><span class="p">,</span> <span class="n">phi2_init</span><span class="p">])</span>
        <span class="n">tx_objs</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">None</span><span class="p">]),</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">wgts</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span>
                   <span class="n">rate_type</span><span class="p">)</span>
        <span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">1e-12</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">params_til</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">wsumsq</span><span class="p">,</span> <span class="n">params_init</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tx_objs</span><span class="p">),</span>
                                  <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">,</span>
                                  <span class="n">tol</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">)</span>
        <span class="n">phi0til</span><span class="p">,</span> <span class="n">phi1til</span><span class="p">,</span> <span class="n">phi2til</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">x</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="n">params_til</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi0til</span><span class="p">,</span> <span class="n">phi1til</span><span class="p">,</span> <span class="n">phi2til</span><span class="p">])</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">elif</span> <span class="n">tax_func_type</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># For linear rates, just take the mean ETR or MTR by age-year.</span>
        <span class="c1"># Can use DEP form and set all parameters except for the shift</span>
        <span class="c1"># parameter to zero.</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">numparams</span><span class="p">)</span>
        <span class="n">wsse</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">txrates</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">params_to_plot</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Choice of tax function is not in the set of&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot; possible tax functions.  Please select&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot; from: DEP, DEP_totalinc, GS, linear.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">pp</span><span class="o">.</span><span class="n">txfunc_graph</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">txrates</span><span class="p">,</span> <span class="n">rate_type</span><span class="p">,</span>
                        <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">get_tax_rates</span><span class="p">,</span> <span class="n">params_to_plot</span><span class="p">,</span>
                        <span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># Garbage collection</span>
    <span class="k">del</span> <span class="n">df</span><span class="p">,</span> <span class="n">txrates</span>

    <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">wsse</span><span class="p">,</span> <span class="n">obs</span></div>


<div class="viewcode-block" id="tax_func_loop"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.tax_func_loop">[docs]</a><span class="k">def</span> <span class="nf">tax_func_loop</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">age_specific</span><span class="p">,</span>
                  <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">analytical_mtrs</span><span class="p">,</span> <span class="n">desc_data</span><span class="p">,</span> <span class="n">graph_data</span><span class="p">,</span>
                  <span class="n">graph_est</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">numparams</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimates tax functions for a particular year.  Looped over.</span>

<span class="sd">    Args:</span>
<span class="sd">        t (int): year of tax data to estimated tax functions for</span>
<span class="sd">        data (Pandas DataFrame): tax return data for year t</span>
<span class="sd">        start_yr (int): first year of budget window</span>
<span class="sd">        s_min (int): minimum age to estimate tax functions for</span>
<span class="sd">        s_max (int): maximum age to estimate tax functions for</span>
<span class="sd">        age_specific (bool): whether to estimate age specific tax</span>
<span class="sd">            functions</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        analytical_mtrs (bool): whether to use the analytical derivation</span>
<span class="sd">            of the marginal tax rates (and thus only need to estimate</span>
<span class="sd">            the effective tax rate functions)</span>
<span class="sd">        desc_data (bool): whether to print descriptive statistics</span>
<span class="sd">        graph_data (bool): whether to plot data</span>
<span class="sd">        graph_est (bool): whether to plot estimated coefficients</span>
<span class="sd">        output_dir (str): path to save output to</span>
<span class="sd">        numparams (int): number of parameters in tax functions</span>

<span class="sd">    Returns:</span>
<span class="sd">        (tuple): tax function estimation output:</span>

<span class="sd">            * TotPop_yr (int): total population derived from micro data</span>
<span class="sd">            * Pct_age (Numpy array): fraction of observations that are</span>
<span class="sd">                in each age bin</span>
<span class="sd">            * AvgInc (scalar): mean income in the data</span>
<span class="sd">            * AvgETR (scalar): mean effective tax rate in data</span>
<span class="sd">            * AvgMTRx (scalar): mean marginal tax rate on labor income</span>
<span class="sd">                in data</span>
<span class="sd">            * AvgMTRy (scalar): mean marginal tax rate on capital income</span>
<span class="sd">                in data</span>
<span class="sd">            * frac_tax_payroll (scalar): fraction of total tax revenue</span>
<span class="sd">                the comes from payroll taxes</span>
<span class="sd">            * etrparam_arr (Numpy array): parameters of the effective</span>
<span class="sd">                tax rate functions</span>
<span class="sd">            * etr_wsumsq_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the effective tax rate functions</span>
<span class="sd">            * etr_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the effective tax rate functions</span>
<span class="sd">            * mtrxparam_arr (Numpy array): parameters of the marginal</span>
<span class="sd">                tax rate on labor income functions</span>
<span class="sd">            * mtrx_wsumsq_arr (Numpy array): weighted sum of squares</span>
<span class="sd">                from estimation of the marginal tax rate on labor income</span>
<span class="sd">                functions</span>
<span class="sd">            * mtrx_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the marginal tax rate on labor income</span>
<span class="sd">                functions</span>
<span class="sd">            * mtryparam_arr (Numpy array): parameters of the marginal</span>
<span class="sd">                tax rate on capital income functions</span>
<span class="sd">            * mtry_wsumsq_arr (Numpy array): weighted sum of squares</span>
<span class="sd">                from estimation of the marginal tax rate on capital</span>
<span class="sd">                income functions</span>
<span class="sd">            * mtry_obs_arr (Numpy array): weighted sum of squares from</span>
<span class="sd">                estimation of the marginal tax rate on capital income</span>
<span class="sd">                functions</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># initialize arrays for output</span>
    <span class="n">etrparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">mtrxparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">mtryparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">etr_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">etr_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtrx_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtrx_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtry_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mtry_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">PopPct_age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Calculate average total income in each year</span>
    <span class="n">AvgInc</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Calculate average ETR and MTRs (weight by population weights</span>
    <span class="c1">#    and income) for each year</span>
    <span class="n">AvgETR</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">AvgMTRx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span>
          <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span>
                                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">AvgMTRy</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span>
          <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">*</span>
                                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Caulcatoe fraction of total tax liability that is from payroll</span>
    <span class="c1"># taxes</span>
    <span class="n">frac_tax_payroll</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;payroll_tax_liab&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_tax_liab&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Calculate total population in each year</span>
    <span class="n">TotPop_yr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Clean up the data by dropping outliers</span>
    <span class="c1"># drop all obs with ETR &gt; MAX_ETR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_ETR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with ETR &lt; MIN_ETR</span>
    <span class="c1"># set min ETR to value at 10th percentile in distribution of ETRs</span>
    <span class="n">MIN_ETR</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_ETR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with total market income, labor income, or</span>
    <span class="c1"># capital income &lt; MIN_INCOME</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;market_income&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)</span> <span class="o">|</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)</span> <span class="o">|</span>
                   <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_INCOME</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on capital income &gt; MAX_MTR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on capital income &lt; MIN_CAP_MTR</span>
    <span class="c1"># set min MTR to value at 10th percentile in distribution of MTRs</span>
    <span class="n">MIN_CAP_MTR</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_CAP_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on labor income &gt; MAX_MTR</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">MAX_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># drop all obs with MTR on labor income &lt; MIN_LAB_MTR</span>
    <span class="n">MIN_LAB_MTR</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.10</span><span class="p">)</span>
    <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_LAB_MTR</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create an array of the different ages in the data</span>
    <span class="n">min_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">s_min</span><span class="p">))</span>
    <span class="n">max_age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">s_max</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_age</span><span class="p">,</span> <span class="n">max_age</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">NoData_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_age</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Each age s must be done in serial</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ages_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Year=&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;Age=&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">]</span>
            <span class="n">PopPct_age</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">min_age</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">TotPop_yr</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;year=&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s2">&quot;age= all ages&quot;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">PopPct_age</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">TotPop_yr</span>
        <span class="n">df_etr</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;etr&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">,</span> <span class="s1">&#39;mtr_capinc&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;total_labinc&#39;</span><span class="p">,</span> <span class="s1">&#39;total_capinc&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;etr&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtrx</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                         <span class="p">[</span><span class="s1">&#39;mtr_labinc&#39;</span><span class="p">,</span> <span class="s1">&#39;total_labinc&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;total_capinc&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_mtry</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_labinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_capinc&#39;</span><span class="p">]))</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]))]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                         <span class="p">[</span><span class="s1">&#39;mtr_capinc&#39;</span><span class="p">,</span> <span class="s1">&#39;total_labinc&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;total_capinc&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_minobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">df_etr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">df_mtrx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">df_mtry</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">del</span> <span class="n">df</span>

        <span class="k">if</span> <span class="n">df_minobs</span> <span class="o">&lt;</span> <span class="n">MIN_OBS</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">max_age</span><span class="p">:</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># Don&#39;t estimate function on this iteration if obs &lt; 500.</span>
            <span class="c1"># Will fill in later with interpolated values</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Insuff. sample size for age &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s2">&quot; in year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">NoData_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">elif</span> <span class="n">df_minobs</span> <span class="o">&lt;</span> <span class="n">MIN_OBS</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="n">max_age</span><span class="p">:</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># If last period does not have sufficient data, fill in</span>
            <span class="c1"># final missing age data with last positive year</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># lastp_etr  = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># lastp_mtrx = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># lastp_mtry = (numparams,) vector, vector of parameter</span>
            <span class="c1">#              estimates from previous age with sufficient</span>
            <span class="c1">#              observations</span>
            <span class="c1"># --------------------------------------------------------</span>
            <span class="c1"># &#39;&#39;&#39;</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Max age (s=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;) insuff. data in&quot;</span>
                       <span class="o">+</span> <span class="s2">&quot; year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span>
                       <span class="s2">&quot;. Fill in final ages with &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;insuff. data with most recent successful &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;estimate.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">NoData_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lastp_etr</span> <span class="o">=</span> <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">lastp_etr</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">lastp_mtrx</span> <span class="o">=</span> <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">lastp_mtrx</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">lastp_mtry</span> <span class="o">=</span> <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                <span class="n">lastp_mtry</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                <span class="p">(</span><span class="n">NoData_cnt</span> <span class="o">+</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Estimate parameters for age with sufficient data</span>
            <span class="k">if</span> <span class="n">desc_data</span><span class="p">:</span>
                <span class="c1"># print some desciptive stats</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Descriptive ETR statistics for age=&quot;</span> <span class="o">+</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_etr</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Descriptive MTRx statistics for age=&quot;</span> <span class="o">+</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_mtrx</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Descriptive MTRy statistics for age=&quot;</span> <span class="o">+</span>
                           <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in year &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">df_mtry</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">graph_data</span><span class="p">:</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">gen_3Dscatters_hist</span><span class="p">(</span><span class="n">df_etr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

            <span class="c1"># Estimate effective tax rate function ETR(x,y)</span>
            <span class="p">(</span><span class="n">etrparams</span><span class="p">,</span> <span class="n">etr_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
             <span class="n">etr_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">])</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                    <span class="n">df_etr</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;etr&#39;</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">numparams</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="p">,</span> <span class="n">graph_est</span><span class="p">)</span>
            <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">etrparams</span>
            <span class="k">del</span> <span class="n">df_etr</span>

            <span class="c1"># Estimate marginal tax rate of labor income function</span>
            <span class="c1"># MTRx(x,y)</span>
            <span class="p">(</span><span class="n">mtrxparams</span><span class="p">,</span> <span class="n">mtrx_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
                <span class="n">mtrx_obs_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">])</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                    <span class="n">df_mtrx</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;mtrx&#39;</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">numparams</span><span class="p">,</span>
                    <span class="n">output_dir</span><span class="p">,</span> <span class="n">graph_est</span><span class="p">)</span>
            <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mtrxparams</span>
            <span class="k">del</span> <span class="n">df_mtrx</span>
            <span class="c1"># Estimate marginal tax rate of capital income function</span>
            <span class="c1"># MTRy(x,y)</span>
            <span class="p">(</span><span class="n">mtryparams</span><span class="p">,</span> <span class="n">mtry_wsumsq_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">],</span>
             <span class="n">mtry_obs_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">s_min</span><span class="p">])</span> <span class="o">=</span> <span class="n">txfunc_est</span><span class="p">(</span>
                 <span class="n">df_mtry</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="s1">&#39;mtry&#39;</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">numparams</span><span class="p">,</span>
                 <span class="n">output_dir</span><span class="p">,</span> <span class="n">graph_est</span><span class="p">)</span>
            <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mtryparams</span>

            <span class="k">del</span> <span class="n">df_mtry</span>

            <span class="k">if</span> <span class="n">NoData_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="n">NoData_cnt</span> <span class="o">==</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">:</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># Fill in initial blanks with first positive data</span>
                <span class="c1"># estimates. This includes the case in which</span>
                <span class="c1"># min_age &gt; s_min</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fill in all previous blank ages&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">etrparam_arr</span><span class="p">[:</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">etrparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mtrxparam_arr</span><span class="p">[:</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mtryparam_arr</span><span class="p">[:</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">NoData_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="n">NoData_cnt</span> <span class="o">&lt;</span> <span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">:</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># Fill in interior data gaps with linear interpolation</span>
                <span class="c1"># between bracketing positive data ages. In all of</span>
                <span class="c1"># these cases min_age &lt; s &lt;= max_age.</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># tvals        = (NoData_cnt+2,) vector, linearly</span>
                <span class="c1">#                space points between 0 and 1</span>
                <span class="c1"># x0_etr       = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at beginning of no data</span>
                <span class="c1">#                spell</span>
                <span class="c1"># x1_etr       = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at end (current period) of</span>
                <span class="c1">#                no data spell</span>
                <span class="c1"># lin_int_etr  = (NoData_cnt x 10) matrix, linearly</span>
                <span class="c1">#                interpolated etr parameters between</span>
                <span class="c1">#                x0_etr and x1_etr</span>
                <span class="c1"># x0_mtrx      = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at beginning of no data</span>
                <span class="c1">#                spell</span>
                <span class="c1"># x1_mtrx      = (NoData_cnt x 10) matrix, positive</span>
                <span class="c1">#                estimates at end (current period) of</span>
                <span class="c1">#                no data spell</span>
                <span class="c1"># lin_int_mtrx = (NoData_cnt x 10) matrix, linearly</span>
                <span class="c1">#                interpolated mtrx parameters between</span>
                <span class="c1">#                x0_mtrx and x1_mtrx</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Linearly interpolate previous blank &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;tax functions&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">tvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">NoData_cnt</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">x0_etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">x1_etr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">etrparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                                 <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">lin_int_etr</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">x0_etr</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">x1_etr</span> <span class="o">-</span> <span class="n">x0_etr</span><span class="p">))</span>
                <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">:</span><span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span>\
                    <span class="n">lin_int_etr</span>
                <span class="n">x0_mtrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="n">NoData_cnt</span><span class="o">-</span><span class="n">s_min</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">x1_mtrx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">lin_int_mtrx</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">x0_mtrx</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">x1_mtrx</span> <span class="o">-</span> <span class="n">x0_mtrx</span><span class="p">))</span>
                <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">:</span><span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">,</span>
                              <span class="p">:]</span> <span class="o">=</span> <span class="n">lin_int_mtrx</span>
                <span class="n">x0_mtry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">x1_mtry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span> <span class="p">(</span><span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">lin_int_mtry</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_mtry</span> <span class="o">+</span> <span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span>
                    <span class="n">NoData_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">x1_mtry</span> <span class="o">-</span> <span class="n">x0_mtry</span><span class="p">))</span>
                <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">NoData_cnt</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">:</span><span class="n">s</span> <span class="o">-</span> <span class="n">min_age</span><span class="p">,</span>
                              <span class="p">:]</span> <span class="o">=</span> <span class="n">lin_int_mtry</span>

            <span class="n">NoData_cnt</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">max_age</span> <span class="ow">and</span> <span class="n">max_age</span> <span class="o">&lt;</span> <span class="n">s_max</span><span class="p">:</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># If the last age estimates, and max_age&lt; s_max, fill</span>
                <span class="c1"># in the remaining ages with these last estimates</span>
                <span class="c1"># ----------------------------------------------------</span>
                <span class="c1"># &#39;&#39;&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Fill in all old tax functions.&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">etrparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">etrparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtrxparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mtryparam_arr</span><span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span>
                    <span class="n">mtryparams</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">numparams</span><span class="p">)),</span>
                    <span class="p">(</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">max_age</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">TotPop_yr</span><span class="p">,</span> <span class="n">PopPct_age</span><span class="p">,</span> <span class="n">AvgInc</span><span class="p">,</span> <span class="n">AvgETR</span><span class="p">,</span> <span class="n">AvgMTRx</span><span class="p">,</span> <span class="n">AvgMTRy</span><span class="p">,</span>
            <span class="n">frac_tax_payroll</span><span class="p">,</span>
            <span class="n">etrparam_arr</span><span class="p">,</span> <span class="n">etr_wsumsq_arr</span><span class="p">,</span> <span class="n">etr_obs_arr</span><span class="p">,</span>
            <span class="n">mtrxparam_arr</span><span class="p">,</span> <span class="n">mtrx_wsumsq_arr</span><span class="p">,</span> <span class="n">mtrx_obs_arr</span><span class="p">,</span>
            <span class="n">mtryparam_arr</span><span class="p">,</span> <span class="n">mtry_wsumsq_arr</span><span class="p">,</span> <span class="n">mtry_obs_arr</span><span class="p">)</span></div>


<div class="viewcode-block" id="tax_func_estimate"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.tax_func_estimate">[docs]</a><span class="k">def</span> <span class="nf">tax_func_estimate</span><span class="p">(</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">starting_age</span><span class="p">,</span> <span class="n">ending_age</span><span class="p">,</span>
                      <span class="n">start_year</span><span class="o">=</span><span class="n">DEFAULT_START_YEAR</span><span class="p">,</span> <span class="n">baseline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">analytical_mtrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="o">=</span><span class="s1">&#39;DEP&#39;</span><span class="p">,</span>
                      <span class="n">age_specific</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reform</span><span class="o">=</span><span class="p">{},</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">desc_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">graph_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">graph_est</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function performs analysis on the source data from Tax-</span>
<span class="sd">    Calculator and estimates functions for the effective tax rate (ETR),</span>
<span class="sd">    marginal tax rate on labor income (MTRx), and marginal tax rate on</span>
<span class="sd">    capital income (MTRy).</span>

<span class="sd">    Args:</span>
<span class="sd">        BW (int): number of years in the budget window (the period</span>
<span class="sd">            over which tax policy is assumed to vary)</span>
<span class="sd">        S (int): number of model periods a model agent is economically</span>
<span class="sd">            active for</span>
<span class="sd">        starting_age (int): minimum age to estimate tax functions for</span>
<span class="sd">        ending_age (int): maximum age to estimate tax functions for</span>
<span class="sd">        start_yr (int): first year of budget window</span>
<span class="sd">        baseline (bool): whether these are the baseline tax functions</span>
<span class="sd">        analytical_mtrs (bool): whether to use the analytical derivation</span>
<span class="sd">            of the marginal tax rates (and thus only need to estimate</span>
<span class="sd">            the effective tax rate functions)</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        age_specific (bool): whether to estimate age specific tax</span>
<span class="sd">            functions</span>
<span class="sd">        reform (dict): policy reform dictionary for Tax-Calculator</span>
<span class="sd">        data (str or Pandas DataFrame): path to or data to use in</span>
<span class="sd">            Tax-Calculator</span>
<span class="sd">        client (Dask client object): client</span>
<span class="sd">        num_workers (int): number of workers to use for parallelization</span>
<span class="sd">            with Dask</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict_param (dict): dictionary with tax function parameters</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">s_min</span> <span class="o">=</span> <span class="n">starting_age</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s_max</span> <span class="o">=</span> <span class="n">ending_age</span>
    <span class="n">start_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_year</span><span class="p">)</span>
    <span class="n">end_yr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_year</span> <span class="o">+</span> <span class="n">BW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;BW = &#39;</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="s2">&quot;begin year = &quot;</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span>
          <span class="s2">&quot;end year = &quot;</span><span class="p">,</span> <span class="n">end_yr</span><span class="p">)</span>
    <span class="n">numparams</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">years_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_year</span><span class="p">,</span> <span class="n">end_yr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ages_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># initialize arrays for output</span>
    <span class="n">etrparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">mtrxparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">mtryparam_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="n">etr_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">etr_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">mtrx_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">mtrx_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">mtry_wsumsq_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">mtry_obs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>
    <span class="n">AvgInc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgETR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgMTRx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">AvgMTRy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">frac_tax_payroll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">TotPop_yr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">BW</span><span class="p">)</span>
    <span class="n">PopPct_age</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s_max</span><span class="o">-</span><span class="n">s_min</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">))</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># Solve for tax functions for each year (t) and each age (s)</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># start_time = scalar, current processor time in seconds (float)</span>
    <span class="c1"># output_dir = string, directory to which plots will be saved</span>
    <span class="c1"># micro_data = dictionary, BW (one for each year) DataFrames,</span>
    <span class="c1">#              each of which has variables with observations from</span>
    <span class="c1">#              Tax-Calculator</span>
    <span class="c1"># t          = integer &gt;= start_year, index for year of analysis</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUR_PATH</span><span class="p">,</span> <span class="s1">&#39;OUTPUT&#39;</span><span class="p">,</span> <span class="s1">&#39;TaxFunctions&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

    <span class="c1"># call tax caculator and get microdata</span>
    <span class="n">micro_data</span><span class="p">,</span> <span class="n">taxcalc_version</span> <span class="o">=</span> <span class="n">get_micro_data</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="n">baseline</span><span class="o">=</span><span class="n">baseline</span><span class="p">,</span> <span class="n">start_year</span><span class="o">=</span><span class="n">start_year</span><span class="p">,</span> <span class="n">reform</span><span class="o">=</span><span class="n">reform</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>

    <span class="n">lazy_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">years_list</span><span class="p">:</span>
        <span class="n">lazy_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">delayed</span><span class="p">(</span><span class="n">tax_func_loop</span><span class="p">)(</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">micro_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)],</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span>
                <span class="n">age_specific</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">analytical_mtrs</span><span class="p">,</span> <span class="n">desc_data</span><span class="p">,</span>
                <span class="n">graph_data</span><span class="p">,</span> <span class="n">graph_est</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">lazy_values</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span>
            <span class="o">*</span><span class="n">lazy_values</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="n">dask</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>

    <span class="c1"># Garbage collection</span>
    <span class="k">del</span> <span class="n">micro_data</span>

    <span class="c1"># for i, result in results.items():</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="p">(</span><span class="n">TotPop_yr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">PopPct_age</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">AvgInc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
         <span class="n">AvgETR</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AvgMTRx</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">AvgMTRy</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">frac_tax_payroll</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
         <span class="n">etrparam_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">etr_wsumsq_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
         <span class="n">etr_obs_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">mtrxparam_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span>
         <span class="n">mtrx_wsumsq_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">mtrx_obs_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
         <span class="n">mtryparam_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mtry_wsumsq_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
         <span class="n">mtry_obs_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">=</span> <span class="n">result</span>

    <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Finished tax function loop through &quot;</span> <span class="o">+</span>
               <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">years_list</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; years and &quot;</span> <span class="o">+</span>
               <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ages_list</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot; ages per year.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Print tax function computation time</span>
    <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>  <span class="c1"># less than a minute</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Tax function estimation time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">elapsed_time</span> <span class="o">&gt;=</span> <span class="mi">60</span> <span class="ow">and</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">3600</span><span class="p">:</span>  <span class="c1"># less than hour</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(((</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="n">mins</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Tax function estimation time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s2">&quot; min, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">elapsed_time</span> <span class="o">&gt;=</span> <span class="mi">3600</span> <span class="ow">and</span> <span class="n">elapsed_time</span> <span class="o">&lt;</span> <span class="mi">86400</span><span class="p">:</span>  <span class="c1"># less than day</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">/</span> <span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
        <span class="n">mins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">elapsed_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">elapsed_time</span> <span class="o">-</span> <span class="p">(</span><span class="n">hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">mins</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Tax function estimation time: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s2">&quot; hour(s), &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; min(s), &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="o">+</span>
                   <span class="s2">&quot; sec(s)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># Replace outlier tax functions (SSE&gt;mean+2.5*std) with linear</span>
    <span class="c1"># linear interpolation. We make two passes (filtering runs).</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="n">age_sup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">s_min</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">s_max</span><span class="o">-</span><span class="n">s_min</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">se_mult</span> <span class="o">=</span> <span class="mf">3.5</span>
        <span class="n">etr_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">etr_wsumsq_arr</span> <span class="o">/</span> <span class="n">etr_obs_arr</span><span class="p">,</span>
                                    <span class="n">age_sup</span><span class="p">,</span> <span class="n">se_mult</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="s2">&quot;ETR&quot;</span><span class="p">,</span>
                                    <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">etr_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">etrparam_arr_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">etrparam_arr</span><span class="p">,</span>
                                                <span class="n">etr_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">etr_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">etrparam_arr_adj</span> <span class="o">=</span> <span class="n">etrparam_arr</span>

        <span class="n">mtrx_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">mtrx_wsumsq_arr</span> <span class="o">/</span> <span class="n">mtrx_obs_arr</span><span class="p">,</span>
                                     <span class="n">age_sup</span><span class="p">,</span> <span class="n">se_mult</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span>
                                     <span class="s2">&quot;MTRx&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mtrx_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtrxparam_arr_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">mtrxparam_arr</span><span class="p">,</span>
                                                 <span class="n">mtrx_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mtrx_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtrxparam_arr_adj</span> <span class="o">=</span> <span class="n">mtrxparam_arr</span>

        <span class="n">mtry_sse_big</span> <span class="o">=</span> <span class="n">find_outliers</span><span class="p">(</span><span class="n">mtry_wsumsq_arr</span> <span class="o">/</span> <span class="n">mtry_obs_arr</span><span class="p">,</span>
                                     <span class="n">age_sup</span><span class="p">,</span> <span class="n">se_mult</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span>
                                     <span class="s2">&quot;MTRy&quot;</span><span class="p">,</span> <span class="n">graph</span><span class="o">=</span><span class="n">graph_est</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mtry_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtryparam_arr_adj</span> <span class="o">=</span> <span class="n">replace_outliers</span><span class="p">(</span><span class="n">mtryparam_arr</span><span class="p">,</span>
                                                 <span class="n">mtry_sse_big</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mtry_sse_big</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mtryparam_arr_adj</span> <span class="o">=</span> <span class="n">mtryparam_arr</span>

    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># Generate tax function parameters for S &lt; s_max - s_min + 1</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># etrparam_arr_S  = S x BW x 10 array, this is an array in which S</span>
    <span class="c1">#                   is less-than-or-equal-to s_max-s_min+1. We use</span>
    <span class="c1">#                   weighted averages of parameters in relevant age</span>
    <span class="c1">#                   groups</span>
    <span class="c1"># mtrxparam_arr_S = S x BW x 10 array, this is an array in which S</span>
    <span class="c1">#                   is less-than-or-equal-to s_max-s_min+1. We use</span>
    <span class="c1">#                   weighted averages of parameters in relevant age</span>
    <span class="c1">#                   groups</span>
    <span class="c1"># age_cuts     = (S+1,) vector, linspace of age cutoffs of S+1 points</span>
    <span class="c1">#                between 0 and S+1</span>
    <span class="c1"># yrcut_lb     = integer &gt;= 0, index of lower bound age for S bin</span>
    <span class="c1"># yrcut_ub     = integer &gt;= 0, index of upper bound age for S bin</span>
    <span class="c1"># rmndr_pct_lb = scalar in [0,1], discounted weight on lower bound age</span>
    <span class="c1"># rmndr_pct_ub = scalar in [0,1], discounted weight on upper bound age</span>
    <span class="c1"># age_wgts     = ages x BW x 10 array, age weights for each age in</span>
    <span class="c1">#                each year copied back 10 times in the 3rd dimension</span>
    <span class="c1"># --------------------------------------------------------------------</span>
    <span class="c1"># &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">age_specific</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">S</span> <span class="o">==</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">etrparam_arr_S</span> <span class="o">=</span> <span class="n">etrparam_arr_adj</span>
            <span class="n">mtrxparam_arr_S</span> <span class="o">=</span> <span class="n">mtrxparam_arr_adj</span>
            <span class="n">mtryparam_arr_S</span> <span class="o">=</span> <span class="n">mtryparam_arr_adj</span>
        <span class="k">elif</span> <span class="n">S</span> <span class="o">&lt;</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">etrparam_arr_S</span> <span class="o">=</span> <span class="n">etrparam_arr_adj</span>
            <span class="n">mtrxparam_arr_S</span> <span class="o">=</span> <span class="n">mtrxparam_arr_adj</span>
            <span class="n">mtryparam_arr_S</span> <span class="o">=</span> <span class="n">mtryparam_arr_adj</span>
            <span class="n">etrparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
            <span class="n">mtrxparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
            <span class="n">mtryparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">S</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">numparams</span><span class="p">))</span>
            <span class="n">age_cuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s_max</span> <span class="o">-</span> <span class="n">s_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">S</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">yrcut_lb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">rmndr_pct_lb</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">S</span><span class="p">):</span>
                <span class="n">yrcut_ub</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="n">rmndr_pct_ub</span> <span class="o">=</span> <span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">age_cuts</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="k">if</span> <span class="n">rmndr_pct_ub</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">rmndr_pct_ub</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">yrcut_ub</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">age_wgts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">PopPct_age</span><span class="p">[</span><span class="n">yrcut_lb</span><span class="p">:</span><span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]]</span> <span class="o">*</span> <span class="n">numparams</span><span class="p">)</span>
                <span class="n">age_wgts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">rmndr_pct_lb</span>
                <span class="n">age_wgts</span><span class="p">[</span><span class="n">yrcut_ub</span><span class="o">-</span><span class="n">yrcut_lb</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*=</span> <span class="n">rmndr_pct_ub</span>
                <span class="n">etrparam_arr_S</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">etrparam_arr_adj</span><span class="p">[</span><span class="n">yrcut_lb</span><span class="p">:</span><span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span>
                    <span class="n">age_wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mtrxparam_arr_S</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mtrxparam_arr_adj</span><span class="p">[</span><span class="n">yrcut_lb</span><span class="p">:</span><span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span>
                    <span class="n">age_wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">mtryparam_arr_S</span><span class="p">[</span><span class="n">s</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">mtryparam_arr_adj</span><span class="p">[</span><span class="n">yrcut_lb</span><span class="p">:</span><span class="n">yrcut_ub</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span>
                    <span class="n">age_wgts</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">yrcut_lb</span> <span class="o">=</span> <span class="n">yrcut_ub</span>
                <span class="n">rmndr_pct_lb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">rmndr_pct_ub</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;S is larger than the difference between the minimum&#39;</span>
                  <span class="o">+</span> <span class="s1">&#39; age and the maximum age specified.  Please choose&#39;</span>
                  <span class="o">+</span> <span class="s1">&#39; and S such that a model period equals at least&#39;</span>
                  <span class="o">+</span> <span class="s1">&#39; one calendar year.&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Big S: &#39;</span><span class="p">,</span> <span class="n">S</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max age, min age: &#39;</span><span class="p">,</span> <span class="n">s_max</span><span class="p">,</span> <span class="n">s_min</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">etrparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">etrparam_arr</span><span class="p">[</span><span class="mi">0</span> <span class="o">-</span> <span class="n">s_min</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">etrparam_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">mtrxparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">mtrxparam_arr</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="n">s_min</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">mtrxparam_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">mtryparam_arr_S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="n">mtryparam_arr</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="n">s_min</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span>
            <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BW</span><span class="p">,</span> <span class="n">mtryparam_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])),</span> <span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="c1"># Save tax function parameters array and computation time in</span>
    <span class="c1"># dictionary</span>
    <span class="n">dict_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[(</span><span class="s1">&#39;tfunc_etr_params_S&#39;</span><span class="p">,</span> <span class="n">etrparam_arr_S</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtrx_params_S&#39;</span><span class="p">,</span> <span class="n">mtrxparam_arr_S</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtry_params_S&#39;</span><span class="p">,</span> <span class="n">mtryparam_arr_S</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_avginc&#39;</span><span class="p">,</span> <span class="n">AvgInc</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tfunc_avg_etr&#39;</span><span class="p">,</span> <span class="n">AvgETR</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_avg_mtrx&#39;</span><span class="p">,</span> <span class="n">AvgMTRx</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tfunc_avg_mtry&#39;</span><span class="p">,</span> <span class="n">AvgMTRy</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_frac_tax_payroll&#39;</span><span class="p">,</span> <span class="n">frac_tax_payroll</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_etr_sumsq&#39;</span><span class="p">,</span> <span class="n">etr_wsumsq_arr</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtrx_sumsq&#39;</span><span class="p">,</span> <span class="n">mtrx_wsumsq_arr</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtry_sumsq&#39;</span><span class="p">,</span> <span class="n">mtry_wsumsq_arr</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_etr_obs&#39;</span><span class="p">,</span> <span class="n">etr_obs_arr</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtrx_obs&#39;</span><span class="p">,</span> <span class="n">mtrx_obs_arr</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tfunc_mtry_obs&#39;</span><span class="p">,</span> <span class="n">mtry_obs_arr</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;tfunc_time&#39;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;tax_func_type&#39;</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;taxcalc_version&#39;</span><span class="p">,</span> <span class="n">taxcalc_version</span><span class="p">),</span>
         <span class="p">(</span><span class="s1">&#39;start_year&#39;</span><span class="p">,</span> <span class="n">start_year</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;BW&#39;</span><span class="p">,</span> <span class="n">BW</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">dict_params</span></div>


<div class="viewcode-block" id="get_tax_func_estimate"><a class="viewcode-back" href="../../txfunc.html#ogusa.txfunc.get_tax_func_estimate">[docs]</a><span class="k">def</span> <span class="nf">get_tax_func_estimate</span><span class="p">(</span><span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">starting_age</span><span class="p">,</span> <span class="n">ending_age</span><span class="p">,</span>
                          <span class="n">baseline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">analytical_mtrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">tax_func_type</span><span class="o">=</span><span class="s1">&#39;DEP&#39;</span><span class="p">,</span> <span class="n">age_specific</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">start_year</span><span class="o">=</span><span class="n">DEFAULT_START_YEAR</span><span class="p">,</span> <span class="n">reform</span><span class="o">=</span><span class="p">{},</span>
                          <span class="n">guid</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tax_func_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function calls the tax function estimation routine and saves</span>
<span class="sd">    the resulting dictionary in pickle files corresponding to the</span>
<span class="sd">    baseline or reform policy.</span>

<span class="sd">    Args:</span>
<span class="sd">        BW (int): number of years in the budget window (the period over</span>
<span class="sd">            which tax policy is assumed to vary)</span>
<span class="sd">        S (int): number of model periods a model agent is economically</span>
<span class="sd">            active for</span>
<span class="sd">        starting_age (int): minimum age to estimate tax functions for</span>
<span class="sd">        ending_age (int): maximum age to estimate tax functions for</span>
<span class="sd">        baseline (bool): whether these are the baseline tax functions</span>
<span class="sd">        analytical_mtrs (bool): whether to use the analytical derivation</span>
<span class="sd">            of the marginal tax rates (and thus only need to estimate</span>
<span class="sd">            the effective tax rate functions)</span>
<span class="sd">        tax_func_type (str): functional form of tax functions</span>
<span class="sd">        age_specific (bool): whether to estimate age specific tax</span>
<span class="sd">            functions</span>
<span class="sd">        start_yr (int): first year of budget window</span>
<span class="sd">        reform (dict): policy reform dictionary for Tax-Calculator</span>
<span class="sd">        guid (str): id for the particular run</span>
<span class="sd">        tax_func_path (str): path to save pickle with estimated tax</span>
<span class="sd">            function parameters to</span>
<span class="sd">        data (str or Pandas DataFrame): path to or data to use in</span>
<span class="sd">            Tax-Calculator</span>
<span class="sd">        client (Dask client object): client</span>
<span class="sd">        num_workers (int): number of workers to use for parallelization</span>
<span class="sd">            with Dask</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dict_params</span> <span class="o">=</span> <span class="n">tax_func_estimate</span><span class="p">(</span>
        <span class="n">BW</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">starting_age</span><span class="p">,</span> <span class="n">ending_age</span><span class="p">,</span> <span class="n">start_year</span><span class="p">,</span> <span class="n">baseline</span><span class="p">,</span>
        <span class="n">analytical_mtrs</span><span class="p">,</span> <span class="n">tax_func_type</span><span class="p">,</span> <span class="n">age_specific</span><span class="p">,</span> <span class="n">reform</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
        <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tax_func_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dict_params</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">OG-USA</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributor_guide.html">Contributor Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../public_api.html">OG-USA API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Jason DeBacker and Richard W. Evans.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>